{% extends "base.html" %}

{% block content %}
<div class="page-container" id="groupContainer" data-group-id="{{ group.group_id if group else '' }}">
    <div class="card">
        <h2>{{ 'Update Group' if group else 'Add New Group' }}</h2>
        
        <form id="groupForm">
            <input type="hidden" name="id" value="{{ group.group_id if group else '' }}">
            
            <div class="form-group" style="margin-bottom: 20px;">
                <label>Group Name</label>
                <input type="text" name="group_name" id="groupName" 
                       value="{{ group.group_name if group else '' }}" 
                       placeholder="e.g. Family, Work, University Friends..." required 
                       style="width: 100%; padding: 10px; margin-top: 5px;">
            </div>

            {% if group %}
            <div style="margin-top: 25px;">
                <label><strong>Current Members:</strong></label>
                <div id="memberList" style="margin-top: 10px; border: 1px solid #444; border-radius: 8px; background: #1a1a1a; padding: 10px;">
                    {% if group.contacts %}
                        {% for contact in group.contacts %}
                        <div class="member-item" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #333;">
                            <span>{{ contact.name }} - {{ contact.phone }}</span>
                            <button type="button" 
                                    onclick="removeMember('{{ group.group_id }}', '{{ contact.contact_id }}', this)" 
                                    style="background: #ff4d4d; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em;">
                                Remove
                            </button>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p style="color: #888; text-align: center; padding: 10px;">No members in this group yet.</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <div style="margin-top: 25px;">
                <label><strong>Add Contacts to Group:</strong></label>
                <div style="max-height: 250px; overflow-y: auto; border: 1px solid #444; padding: 12px; border-radius: 8px; background: #1a1a1a; margin-top: 10px;">
                    {% for contact in all_contacts %}
                        {% if not group or contact not in group.contacts %}
                        <div style="margin-bottom: 12px; display: flex; align-items: center;">
                            <input type="checkbox" name="contact_ids" value="{{ contact.contact_id }}" 
                                   id="c{{ contact.contact_id }}" style="width: 18px; height: 18px; cursor: pointer;">
                            <label for="c{{ contact.contact_id }}" style="margin-left: 12px; cursor: pointer; flex-grow: 1;">
                                {{ contact.name }} <span style="color: #888; font-size: 0.9em;">({{ contact.phone }})</span>
                            </label>
                        </div>
                        {% endif %}
                    {% else %}
                        <p style="color: #888; font-size: 0.9em; text-align: center;">No contacts available to add.</p>
                    {% endfor %}
                </div>
            </div>

            <button type="submit" class="add-btn" style="margin-top: 30px; width: 100%; padding: 12px; font-weight: bold;">
                {{ 'Save Changes' if group else 'Create Group' }}
            </button>
            
            <p id="groupMsg" style="margin-top: 15px; text-align: center; font-weight: bold;"></p>
        </form>
        
        <div style="text-align: center; margin-top: 25px; border-top: 1px solid #333; padding-top: 15px;">
            <a href="/groups" style="color: #aaa; text-decoration: none; font-size: 0.95em;">‚Üê Back to Group List</a>
        </div>
    </div>
</div>

<script>
/**
 * Remove a member directly from the group without submitting the whole form
 */
function removeMember(groupId, contactId, btnElement) {
    if (!confirm("Are you sure you want to remove this contact from the group?")) return;

    btnElement.disabled = true;
    btnElement.innerText = "Removing...";

    fetch(`/api/group/${groupId}/remove_member/${contactId}`, {
        method: "POST"
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "success") {
            const item = btnElement.parentElement;
            item.style.transition = "0.3s";
            item.style.opacity = "0";
            item.style.transform = "translateX(20px)";
            
            setTimeout(() => {
                item.remove();
                // If no members left, show empty message
                const list = document.getElementById('memberList');
                if (list && list.querySelectorAll('.member-item').length === 0) {
                    list.innerHTML = '<p style="color: #888; text-align: center; padding: 10px;">No members in this group yet.</p>';
                }
            }, 300);
        } else {
            alert("Error: " + data.message);
            btnElement.disabled = false;
            btnElement.innerText = "Remove";
        }
    })
    .catch(err => {
        console.error(err);
        alert("Server connection error");
        btnElement.disabled = false;
    });
}
</script>

<script src="{{ url_for('static', filename='group.js') }}"></script>
{% endblock %}